<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Multicore &amp; Locks | The EGOS book</title>
    <meta name="description" content="Envision a future where every student can read all the code of a teaching operating system. ">
    <meta name="generator" content="VitePress v1.3.4">
    <link rel="preload stylesheet" href="/assets/style.BIc4tlAO.css" as="style">
    
    <script type="module" src="/assets/app.D9uQzcqb.js"></script>
    <link rel="preload" href="/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/assets/chunks/theme.CiT-GGh0.js">
    <link rel="modulepreload" href="/assets/chunks/framework.CeQAp18V.js">
    <link rel="modulepreload" href="/assets/book_p8_lock.md.BCxPn2W8.lean.js">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-d8b57b2d><!--[--><!--]--><!--[--><span tabindex="-1" data-v-c8291ffa></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-c8291ffa> Skip to content </a><!--]--><!----><header class="VPNav" data-v-d8b57b2d data-v-7ad780c2><div class="VPNavBar has-sidebar top" data-v-7ad780c2 data-v-9fd4d1dd><div class="wrapper" data-v-9fd4d1dd><div class="container" data-v-9fd4d1dd><div class="title" data-v-9fd4d1dd><div class="VPNavBarTitle has-sidebar" data-v-9fd4d1dd data-v-0ad69264><a class="title" href="/" data-v-0ad69264><!--[--><!--]--><!----><span data-v-0ad69264>The EGOS book</span><!--[--><!--]--></a></div></div><div class="content" data-v-9fd4d1dd><div class="content-body" data-v-9fd4d1dd><!--[--><!--]--><div class="VPNavBarSearch search" data-v-9fd4d1dd><!----></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-9fd4d1dd data-v-afb2845e><span id="main-nav-aria-label" class="visually-hidden" data-v-afb2845e> Main Navigation </span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/" tabindex="0" data-v-afb2845e data-v-08fbf4b6><!--[--><span data-v-08fbf4b6>Vision</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/book/overview.html" tabindex="0" data-v-afb2845e data-v-08fbf4b6><!--[--><span data-v-08fbf4b6>Overview</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-9fd4d1dd data-v-3f90c1a5><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-3f90c1a5 data-v-be9742d9 data-v-b4ccac88><span class="check" data-v-b4ccac88><span class="icon" data-v-b4ccac88><!--[--><span class="vpi-sun sun" data-v-be9742d9></span><span class="vpi-moon moon" data-v-be9742d9></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-9fd4d1dd data-v-ef6192dc data-v-e71e869c><!--[--><a class="VPSocialLink no-icon" href="https://github.com/yhzhang0128/egos-2000" aria-label="github" target="_blank" rel="noopener" data-v-e71e869c data-v-358b6670><span class="vpi-social-github" /></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-9fd4d1dd data-v-f953d92f data-v-af5898d3><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-af5898d3><span class="vpi-more-horizontal icon" data-v-af5898d3></span></button><div class="menu" data-v-af5898d3><div class="VPMenu" data-v-af5898d3 data-v-20ed86d6><!----><!--[--><!--[--><!----><div class="group" data-v-f953d92f><div class="item appearance" data-v-f953d92f><p class="label" data-v-f953d92f>Appearance</p><div class="appearance-action" data-v-f953d92f><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-f953d92f data-v-be9742d9 data-v-b4ccac88><span class="check" data-v-b4ccac88><span class="icon" data-v-b4ccac88><!--[--><span class="vpi-sun sun" data-v-be9742d9></span><span class="vpi-moon moon" data-v-be9742d9></span><!--]--></span></span></button></div></div></div><div class="group" data-v-f953d92f><div class="item social-links" data-v-f953d92f><div class="VPSocialLinks social-links-list" data-v-f953d92f data-v-e71e869c><!--[--><a class="VPSocialLink no-icon" href="https://github.com/yhzhang0128/egos-2000" aria-label="github" target="_blank" rel="noopener" data-v-e71e869c data-v-358b6670><span class="vpi-social-github" /></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-9fd4d1dd data-v-6bee1efd><span class="container" data-v-6bee1efd><span class="top" data-v-6bee1efd></span><span class="middle" data-v-6bee1efd></span><span class="bottom" data-v-6bee1efd></span></span></button></div></div></div></div><div class="divider" data-v-9fd4d1dd><div class="divider-line" data-v-9fd4d1dd></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-d8b57b2d data-v-2488c25a><div class="container" data-v-2488c25a><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-2488c25a><span class="vpi-align-left menu-icon" data-v-2488c25a></span><span class="menu-text" data-v-2488c25a>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-2488c25a data-v-883964e0><button data-v-883964e0>Return to top</button><!----></div></div></div><aside class="VPSidebar" data-v-d8b57b2d data-v-42c4c606><div class="curtain" data-v-42c4c606></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-42c4c606><span class="visually-hidden" id="sidebar-aria-label" data-v-42c4c606> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="no-transition group" data-v-51288d80><section class="VPSidebarItem level-0 has-active" data-v-51288d80 data-v-edd2eed8><!----><div class="items" data-v-edd2eed8><!--[--><div class="VPSidebarItem level-1 is-link" data-v-edd2eed8 data-v-edd2eed8><div class="item" data-v-edd2eed8><div class="indicator" data-v-edd2eed8></div><a class="VPLink link link" href="/book/overview.html" data-v-edd2eed8><!--[--><p class="text" data-v-edd2eed8>Overview</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-edd2eed8 data-v-edd2eed8><div class="item" data-v-edd2eed8><div class="indicator" data-v-edd2eed8></div><a class="VPLink link link" href="/book/p0_hello.html" data-v-edd2eed8><!--[--><p class="text" data-v-edd2eed8>P0: Hello, World!</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-edd2eed8 data-v-edd2eed8><div class="item" data-v-edd2eed8><div class="indicator" data-v-edd2eed8></div><a class="VPLink link link" href="/book/p1_ct.html" data-v-edd2eed8><!--[--><p class="text" data-v-edd2eed8>P1: Cooperative Threads</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-edd2eed8 data-v-edd2eed8><div class="item" data-v-edd2eed8><div class="indicator" data-v-edd2eed8></div><a class="VPLink link link" href="/book/p2_mlfq.html" data-v-edd2eed8><!--[--><p class="text" data-v-edd2eed8>P2: Preemptive Scheduler</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-edd2eed8 data-v-edd2eed8><div class="item" data-v-edd2eed8><div class="indicator" data-v-edd2eed8></div><a class="VPLink link link" href="/book/p3_syscall.html" data-v-edd2eed8><!--[--><p class="text" data-v-edd2eed8>P3: System Call & Protection</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-edd2eed8 data-v-edd2eed8><div class="item" data-v-edd2eed8><div class="indicator" data-v-edd2eed8></div><a class="VPLink link link" href="/book/p4_vm.html" data-v-edd2eed8><!--[--><p class="text" data-v-edd2eed8>P4: Virtual Memory</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-edd2eed8 data-v-edd2eed8><div class="item" data-v-edd2eed8><div class="indicator" data-v-edd2eed8></div><a class="VPLink link link" href="/book/p5_io.html" data-v-edd2eed8><!--[--><p class="text" data-v-edd2eed8>P5: I/O Device Driver</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-edd2eed8 data-v-edd2eed8><div class="item" data-v-edd2eed8><div class="indicator" data-v-edd2eed8></div><a class="VPLink link link" href="/book/p6_file.html" data-v-edd2eed8><!--[--><p class="text" data-v-edd2eed8>P6: File System</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-edd2eed8 data-v-edd2eed8><div class="item" data-v-edd2eed8><div class="indicator" data-v-edd2eed8></div><a class="VPLink link link" href="/book/p7_net.html" data-v-edd2eed8><!--[--><p class="text" data-v-edd2eed8>P7: Ethernet & TCP/IP</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-edd2eed8 data-v-edd2eed8><div class="item" data-v-edd2eed8><div class="indicator" data-v-edd2eed8></div><a class="VPLink link link" href="/book/p8_lock.html" data-v-edd2eed8><!--[--><p class="text" data-v-edd2eed8>P8: Multicore & Locks</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-edd2eed8 data-v-edd2eed8><div class="item" data-v-edd2eed8><div class="indicator" data-v-edd2eed8></div><a class="VPLink link link" href="/book/outcome.html" data-v-edd2eed8><!--[--><p class="text" data-v-edd2eed8>The Learning Outcomes</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-d8b57b2d data-v-9a6c75ad><div class="VPDoc has-sidebar has-aside" data-v-9a6c75ad data-v-e6f2a212><!--[--><!--]--><div class="container" data-v-e6f2a212><div class="aside" data-v-e6f2a212><div class="aside-curtain" data-v-e6f2a212></div><div class="aside-container" data-v-e6f2a212><div class="aside-content" data-v-e6f2a212><div class="VPDocAside" data-v-e6f2a212 data-v-cb998dce><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-cb998dce data-v-f610f197><div class="content" data-v-f610f197><div class="outline-marker" data-v-f610f197></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-f610f197>On this page</div><ul class="VPDocOutlineItem root" data-v-f610f197 data-v-53c99d69><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-cb998dce></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-e6f2a212><div class="content-container" data-v-e6f2a212><!--[--><!--]--><main class="main" data-v-e6f2a212><div style="position:relative;" class="vp-doc _book_p8_lock" data-v-e6f2a212><div><h1 id="multicore-locks" tabindex="-1">Multicore &amp; Locks <a class="header-anchor" href="#multicore-locks" aria-label="Permalink to &quot;Multicore &amp; Locks&quot;">​</a></h1><p>By far, we have been running the operating system and user applications on one CPU core, but multicore CPUs have been widely used. A laptop typically has a CPU with 4 to 16 cores while the CPU on a server machine in a data center could have 64 or more cores. Multicore leads to higher software performance because multiple processes run on different cores at the same time, and therefore multiple software tasks can make progress in parallel.</p><p>Handling multiple cores involves an important concept called <strong>mutual exclusion</strong>. In general, mutual exclusion prevents multiple CPU cores from using a shared resource simultaneously. For example, when the kernel code is running on a core and updating some data structure (e.g., the PCB), it may need exclusive access to the data structure. Otherwise, these kernel data structures can be corrupted by simultaneous updates by multiple cores. We thus start by introducing mutual exclusion.</p><h2 id="mutual-exclusion" tabindex="-1">Mutual exclusion <a class="header-anchor" href="#mutual-exclusion" aria-label="Permalink to &quot;Mutual exclusion&quot;">​</a></h2><p>When you run egos-2000 on QEMU, you may have noticed that the first line printed is one of the four possibilities listed below. In other words, a core is randomly selected from #1 .. #4 to boot egos-2000 when you run it on QEMU.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>[CRITICAL] --- Booting on QEMU with core #1 ---</span></span>
<span class="line"><span>[CRITICAL] --- Booting on QEMU with core #2 ---</span></span>
<span class="line"><span>[CRITICAL] --- Booting on QEMU with core #3 ---</span></span>
<span class="line"><span>[CRITICAL] --- Booting on QEMU with core #4 ---</span></span></code></pre></div><p>This is a typical example of mutual exclusion. Specifically, the public egos-2000 code only runs on a single core, so the booting code (aka. <strong>boot loader</strong>) will prevent the other 3 cores from running egos-2000 after egos-2000 has already started to run on a core. Such mutual exclusion requires a new class of CPU instructions called <strong>atomic memory operations</strong> which is an extension to the basic RISC-V instruction set architecture.</p><h3 id="atomic-memory-operation" tabindex="-1">Atomic memory operation <a class="header-anchor" href="#atomic-memory-operation" aria-label="Permalink to &quot;Atomic memory operation&quot;">​</a></h3><p>The assembly code below is from <code>earth/boot.s</code> which shows the first instructions that all the CPU cores will execute when running egos-2000.</p><div class="language-asm vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">asm</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">boot_loader:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    la t0, boot_lock</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    li t1, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    amoswap.w.aq t1, t1, (t0)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    bnez t1, boot_loader</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    li </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">sp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0x80200000</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    call</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> boot</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.bss</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    boot_lock:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">       .</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">word</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    booted_core_cnt:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> .</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">word</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>Line 9 means that there is a 4-byte variable named <code>boot_lock</code> that is initialized as 0 before all the cores start to execute the first instruction (i.e., the <code>la</code> instruction in <code>boot_loader</code>). The first two instructions load the address of <code>boot_lock</code> to register <code>t0</code> and load value <code>1</code> to register <code>t1</code>. The magic happens at the <code>amoswap.w.aq</code> instruction where <code>amo</code> stands for atomic memory operation. It swaps the value of <code>t1</code> with the 4 bytes at memory address <code>t0</code> <em>atomically</em>. Atomicity means that only one of the 4 cores could swap back the initial <code>0</code> value of <code>boot_lock</code>, after which all the other cores will swap back value <code>1</code>.</p><p>The first core that completes <code>amoswap.w.aq</code> will call <code>boot()</code> and, as long as <code>boot_lock</code> continues to hold value <code>1</code>, the other cores will be trapped into an infinite loop because of the <code>bnez</code> instruction.</p><div class="tip custom-block github-alert"><p class="custom-block-title">TIP</p><p>The magic of <code>amoswap.w.aq</code> is enforced by the CPU hardware design. The CPU hardware decides which core should be the first when multiple cores try to execute this instruction at the same time. This is closely related to the <a href="https://en.wikipedia.org/wiki/Memory_coherence" target="_blank" rel="noreferrer">memory coherence</a> problem in computer architecture.</p></div><p>We say that the code above <em>acquires</em> the boot lock and one can <em>release</em> this lock by writing value <code>0</code> to the address of <code>boot_lock</code>. After releasing the boot lock, another core would be able to acquire it, and proceed with calling <code>boot()</code>.</p><p>In general, a <strong>lock</strong> is simply a 4-byte variable in the memory holding either <code>0</code> or <code>1</code>. Given a lock variable <code>x</code> in C, we have provided two macros for you in <code>library/egos.h</code>.</p><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* The __sync_lock_* functions are defined within the C compiler. */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> release</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">x</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">__sync_lock_release</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">x);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> acquire</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">x</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">__sync_lock_test_and_set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">x, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>While you still need to write some assembly code in this project, you can use these macros whenever you need to acquire or release a lock in your C code. Now, release the boot lock, and see what will happen.</p><h3 id="release-the-boot-lock" tabindex="-1">Release the boot lock <a class="header-anchor" href="#release-the-boot-lock" aria-label="Permalink to &quot;Release the boot lock&quot;">​</a></h3><p>Since <code>booted_core_cnt</code> is initially 0 just like <code>boot_lock</code>, the first booted core will enter the if branch in <code>boot()</code>, and calls 4 initialization functions: <code>tty_init</code>, <code>disk_init</code>, <code>mmu_init</code>, and <code>intr_init</code>. They initialize the TTY and disk devices, and the CSRs for virtual memory and interrupts. Lastly, <code>boot()</code> calls the <code>grass_entry</code> function defined in <code>grass/init.c</code>.</p><p>The <code>grass_entry</code> function loads the binary executable for <code>apps/system/sys_proc.c</code> into memory as the first process, and start to run this process after the <code>mret</code> instruction. Note that after this <code>mret</code>, the first process will set the stack pointer to <code>0x80400000</code> as shown in <code>apps/app.s</code>. This means that the first booted core has <em>finished using the kernel stack</em>, so we can now safely release the boot lock and allow the next core to call <code>boot()</code>.</p><p>We thus ask you to release the boot lock at the start of <code>apps/system/sys_proc.c</code>. Because <code>grass_entry()</code> has passed the address of <code>boot_lock</code> to this process as an argument for its <code>main</code> function, you can access <code>boot_lock</code> through the <code>struct multicore*</code> argument. Here is one possible printing after you release the boot lock.</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>&gt; make qemu</span></span>
<span class="line"><span>...</span></span>
<span class="line"><span>[CRITICAL] --- Booting on QEMU with core #1 ---</span></span>
<span class="line"><span>...</span></span>
<span class="line"><span>[SUCCESS] Enter kernel process GPID_PROCESS</span></span>
<span class="line"><span>[SUCCESS] --- Core #4[INFO] Load kern el process #2: sys_tserminal</span></span>
<span class="line"><span>tarts running ---</span></span>
<span class="line"><span>[INFO] Load 0xde8 bytes to 0x80200000</span></span>
<span class="line"><span>[INFO] Load 0x11c bytes to 0x80208000</span></span>
<span class="line"><span>[SUCCESS] Enter kernel process GPID_TERMINAL</span></span>
<span class="line"><span>...</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>Essentially, the first process prints out <code>Enter kernel process GPID_PROCESS</code> normally, but the printing of <code>[INFO] Load kernel process #2: sys_terminal</code> is mixed with the printing of <code>[SUCCESS] --- Core #4 starts running ---</code> defined in <code>earth/boot.c</code>. This is exactly the result of core #1 running the first process while core #4 running <code>boot()</code> in parallel.</p><h2 id="complete-the-boot-loader" tabindex="-1">Complete the boot loader <a class="header-anchor" href="#complete-the-boot-loader" aria-label="Permalink to &quot;Complete the boot loader&quot;">​</a></h2><p>Start with a fresh copy of egos-2000, and incorporate your code for virtual memory in P4.</p><p>Your first task is to complete the code in <code>apps/system/sys_proc.c</code> and <code>earth/boot.c</code>, so all the cores finish booting. Specifically, the 3 cores booting after the first one should set up their own CSRs for interrupt and virtual memory, but they do not initialize the devices again. Note that each core owns their own set of CSRs. In particular, multicore requires page table translation, so simply do a <code>FATAL</code> in your code if <code>SOFT_TLB</code> has been chosen.</p><p>The goal is to see <code>[SUCCESS] --- Core #? starts running ---</code> for all the 3 cores, so we know that all the 4 cores have booted. However, you will likely meet exceptions and <code>FATAL</code> in <code>excp_entry()</code> in the kernel since we have not yet protected the kernel code with locks.</p><h2 id="kernel-lock" tabindex="-1">Kernel lock <a class="header-anchor" href="#kernel-lock" aria-label="Permalink to &quot;Kernel lock&quot;">​</a></h2><p>As we have mentioned, if multiple CPU cores use the kernel stack or update the kernel data structures at the same time, these memory regions can be corrupted. Therefore, we define <code>kernel_lock</code> in <code>grass/kernel.s</code> which should ensure that, at any time, only one core can access the kernel stack or data structures. Your job is to protect the kernel by acquiring and releasing the <code>kernel_lock</code>.</p><h3 id="protect-the-kernel" tabindex="-1">Protect the kernel <a class="header-anchor" href="#protect-the-kernel" aria-label="Permalink to &quot;Protect the kernel&quot;">​</a></h3><p>Recall the <code>trap_entry</code> defined in <code>grass/kernel.s</code> which is first introduced in P2. It is the entry point of all the interrupts or exceptions trapping a CPU core into the kernel. If multiple cores get trapped at the same time, they will all execute the instructions in <code>trap_entry</code> and thus use the kernel stack at <code>0x80200000</code>.</p><p>Intuitively, you will need to acquire the kernel lock before switching to the kernel stack and release the kernel lock right before the <code>mret</code> in <code>trap_entry</code>. There is one key difference from how this is done in <code>earth/boot.s</code>. Recall that <code>trap_entry</code> saves all the registers on the kernel stack before calling <code>kernel_entry</code>, and restores all the registers before <code>mret</code>. This requires that your code for acquiring or releasing the lock does not modify the value of any registers. This can be achieved by using the so-called scratch CSRs such as <code>mscratch</code> and <code>ssratch</code>. For example, to keep the value of the <code>sp</code> register, <code>trap_entry</code> has already been using the <code>mscratch</code> CSR to record the old value of <code>sp</code>.</p><p>After your modifications to <code>grass/kernel.s</code>, there is only one more thing you need to do in <code>grass/kernel.c</code>. Given multiple CPU cores, it is possible that a core has to be idle, i.e., the scheduler cannot find a RUNNABLE process to run on this core. As a result, we need to ask an idle core to do nothing before it gets the next timer interrupt. You have seen this situation when implementing <code>sleep</code> in P3, and you need to handle it again in <code>proc_yield</code>.</p><div class="tip custom-block github-alert"><p class="custom-block-title">TIP</p><p>We use a single lock to protect the whole kernel because it is simple. In many operating systems, there are separate kernel stacks dedicated to different CPU cores so that kernel stacks don&#39;t need to be protected by locks. There are different locks protecting the other kernel data structures.</p></div><h3 id="run-processes-in-parallel" tabindex="-1">Run processes in parallel <a class="header-anchor" href="#run-processes-in-parallel" aria-label="Permalink to &quot;Run processes in parallel&quot;">​</a></h3><p>Now, let us run multiple processes on different CPU cores, and see whether our kernel can indeed handle multicore. Specifically, you will implement the <code>proc_coresinfo</code> function at the end of <code>grass/kernel.c</code> and add this function into <code>struct grass</code>, so the shell can call this function for its built-in command <code>coresinfo</code> (see hints in <code>apps/system/sys_shell.c</code>). After you finish, run multiple processes in the background, and try <code>coresinfo</code>.</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>&gt; make qemu</span></span>
<span class="line"><span>...</span></span>
<span class="line"><span>[CRITICAL] Welcome to the egos-2000 shell!</span></span>
<span class="line"><span>➜ /home/yunhao loop &amp;</span></span>
<span class="line"><span>[INFO] process 6 running in the background</span></span>
<span class="line"><span>➜ /home/yunhao loop &amp;</span></span>
<span class="line"><span>[INFO] process 7 running in the background</span></span>
<span class="line"><span>➜ /home/yunhao loop &amp;</span></span>
<span class="line"><span>[INFO] process 8 running in the background</span></span>
<span class="line"><span>➜ /home/yunhao loop &amp;</span></span>
<span class="line"><span>[INFO] process 9 running in the background</span></span>
<span class="line highlighted"><span>➜ /home/yunhao coresinfo</span></span>
<span class="line"><span>[INFO] ==============Core ID / Process ID==============</span></span>
<span class="line"><span>[INFO] Core #1 is running pid=6</span></span>
<span class="line"><span>[INFO] Core #2 is running pid=4 (GPID_SHELL)</span></span>
<span class="line"><span>[INFO] Core #3 is running pid=7</span></span>
<span class="line"><span>[INFO] Core #4 is running pid=9</span></span>
<span class="line highlighted"><span>➜ /home/yunhao coresinfo</span></span>
<span class="line"><span>[INFO] ==============Core ID / Process ID==============</span></span>
<span class="line"><span>[INFO] Core #1 is running pid=8</span></span>
<span class="line"><span>[INFO] Core #2 is running pid=9</span></span>
<span class="line"><span>[INFO] Core #3 is running pid=4 (GPID_SHELL)</span></span>
<span class="line"><span>[INFO] Core #4 is running pid=7</span></span>
<span class="line"><span>...</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>In this demo, we started 4 processes in the background and, if we run <code>coresinfo</code> multiple times, different cores would be running different processes. For the first <code>coresinfo</code> above, processes #6, #7 and #9 were running while #8 was not running (i.e., RUNNABLE). You can also try the <code>killall</code> built-in command after which all the background <code>loop</code> will terminate. Here is a <a href="https://youtu.be/sUIznQKcGu8" target="_blank" rel="noreferrer">video with more details of this demo</a>.</p><h2 id="find-concurrency-bugs" tabindex="-1">Find concurrency bugs <a class="header-anchor" href="#find-concurrency-bugs" aria-label="Permalink to &quot;Find concurrency bugs&quot;">​</a></h2><p>Being able to run a demo does not mean that your code is free of bugs. <em>Concurrency bugs</em> refer to bugs that could happen when multiple programs are running concurrently. For this project, a concurrency bug could be programs running on different cores modifying certain kernel data structures at the same time. While we have protected the kernel with the kernel lock, such concurrency bugs still exist. See whether you can find and fix them.</p><p>In general, concurrency bugs are difficult to find and debug because they typically happen neither deterministically nor often. Given that egos-2000 has a small code base and it uses simple data structures, a good way to remove concurrency bugs is to reason about the use of all the data structures very carefully.</p><div class="tip custom-block github-alert"><p class="custom-block-title">TIP</p><p>If you wish to learn more about parallel programming in operating systems, this book is a fun read: <a href="https://arxiv.org/abs/1701.00854" target="_blank" rel="noreferrer">Is Parallel Programming Hard, And, If So, What Can You Do About It? </a> Also, if you run your code on the Arty board, you need to add a few <code>nop</code> after each <code>amoswap</code> instruction. The reason is that the CPU design for the Arty board has a flaw, and it cannot complete the <code>amoswap</code> instruction in one CPU cycle. By adding a few <code>nop</code>, the CPU core waits for <code>amoswap</code> to complete before proceeding into a <a href="https://en.wikipedia.org/wiki/Critical_section" target="_blank" rel="noreferrer">critical section</a>. The Tang Nano 20K board does not support multicore right now.</p></div><h2 id="accomplishments" tabindex="-1">Accomplishments <a class="header-anchor" href="#accomplishments" aria-label="Permalink to &quot;Accomplishments&quot;">​</a></h2><p>You have gained some experience with atomic memory operations, the extension to RISC-V instruction set for multicore. You have seen how multiple cores run code in parallel resulting in an interleaved printing, and how to protect the kernel with a lock. Lastly, you have tried to find and fix concurrency bugs which may not happen often or deterministically.</p></div></div></main><footer class="VPDocFooter" data-v-e6f2a212 data-v-1bcd8184><!--[--><!--]--><!----><nav class="prev-next" aria-labelledby="doc-footer-aria-label" data-v-1bcd8184><span class="visually-hidden" id="doc-footer-aria-label" data-v-1bcd8184>Pager</span><div class="pager" data-v-1bcd8184><a class="VPLink link pager-link prev" href="/book/p7_net.html" data-v-1bcd8184><!--[--><span class="desc" data-v-1bcd8184>Previous page</span><span class="title" data-v-1bcd8184>P7: Ethernet & TCP/IP</span><!--]--></a></div><div class="pager" data-v-1bcd8184><a class="VPLink link pager-link next" href="/book/outcome.html" data-v-1bcd8184><!--[--><span class="desc" data-v-1bcd8184>Next page</span><span class="title" data-v-1bcd8184>The Learning Outcomes</span><!--]--></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><footer class="VPFooter has-sidebar" data-v-d8b57b2d data-v-566314d4><div class="container" data-v-566314d4><p class="message" data-v-566314d4>"... any person ... any study."</p><p class="copyright" data-v-566314d4>Ezra Cornell (1807-1874)</p></div></footer><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"book_outcome.md\":\"_8r2kCAx\",\"book_overview.md\":\"D7yRGCz-\",\"book_p0_hello.md\":\"BDM6QSoh\",\"book_p1_ct.md\":\"CbcEPFJO\",\"book_p2_mlfq.md\":\"CESUtVLQ\",\"book_p3_syscall.md\":\"_Z5BMgGY\",\"book_p4_vm.md\":\"BjPznP2K\",\"book_p5_io.md\":\"DRjF7mqi\",\"book_p6_file.md\":\"B4ou-fA7\",\"book_p7_net.md\":\"DxcH4tVM\",\"book_p8_lock.md\":\"BCxPn2W8\",\"index.md\":\"SRIk_n0M\",\"readme.md\":\"BKydlJrD\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"The EGOS book\",\"description\":\"Envision a future where every student can read all the code of a teaching operating system. \",\"base\":\"/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"nav\":[{\"text\":\"Vision\",\"link\":\"/\"},{\"text\":\"Overview\",\"link\":\"/book/overview\"}],\"sidebar\":[{\"items\":[{\"text\":\"Overview\",\"link\":\"/book/overview\"},{\"text\":\"P0: Hello, World!\",\"link\":\"/book/p0_hello\"},{\"text\":\"P1: Cooperative Threads\",\"link\":\"/book/p1_ct\"},{\"text\":\"P2: Preemptive Scheduler\",\"link\":\"/book/p2_mlfq\"},{\"text\":\"P3: System Call & Protection\",\"link\":\"/book/p3_syscall\"},{\"text\":\"P4: Virtual Memory\",\"link\":\"/book/p4_vm\"},{\"text\":\"P5: I/O Device Driver\",\"link\":\"/book/p5_io\"},{\"text\":\"P6: File System\",\"link\":\"/book/p6_file\"},{\"text\":\"P7: Ethernet & TCP/IP\",\"link\":\"/book/p7_net\"},{\"text\":\"P8: Multicore & Locks\",\"link\":\"/book/p8_lock\"},{\"text\":\"The Learning Outcomes\",\"link\":\"/book/outcome\"}]}],\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/yhzhang0128/egos-2000\"}],\"footer\":{\"copyright\":\"Ezra Cornell (1807-1874)\",\"message\":\"\\\"... any person ... any study.\\\"\"}},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":false}");</script>
    
  </body>
</html>