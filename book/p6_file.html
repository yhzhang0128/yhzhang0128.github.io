<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>File System | The EGOS book</title>
    <meta name="description" content="Envision a future where every student can read all the code of a teaching operating system. ">
    <meta name="generator" content="VitePress v1.3.4">
    <link rel="preload stylesheet" href="/assets/style.BIc4tlAO.css" as="style">
    
    <script type="module" src="/assets/app.D9uQzcqb.js"></script>
    <link rel="preload" href="/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/assets/chunks/theme.CiT-GGh0.js">
    <link rel="modulepreload" href="/assets/chunks/framework.CeQAp18V.js">
    <link rel="modulepreload" href="/assets/book_p6_file.md.B4ou-fA7.lean.js">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-d8b57b2d><!--[--><!--]--><!--[--><span tabindex="-1" data-v-c8291ffa></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-c8291ffa> Skip to content </a><!--]--><!----><header class="VPNav" data-v-d8b57b2d data-v-7ad780c2><div class="VPNavBar has-sidebar top" data-v-7ad780c2 data-v-9fd4d1dd><div class="wrapper" data-v-9fd4d1dd><div class="container" data-v-9fd4d1dd><div class="title" data-v-9fd4d1dd><div class="VPNavBarTitle has-sidebar" data-v-9fd4d1dd data-v-0ad69264><a class="title" href="/" data-v-0ad69264><!--[--><!--]--><!----><span data-v-0ad69264>The EGOS book</span><!--[--><!--]--></a></div></div><div class="content" data-v-9fd4d1dd><div class="content-body" data-v-9fd4d1dd><!--[--><!--]--><div class="VPNavBarSearch search" data-v-9fd4d1dd><!----></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-9fd4d1dd data-v-afb2845e><span id="main-nav-aria-label" class="visually-hidden" data-v-afb2845e> Main Navigation </span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/" tabindex="0" data-v-afb2845e data-v-08fbf4b6><!--[--><span data-v-08fbf4b6>Vision</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/book/overview.html" tabindex="0" data-v-afb2845e data-v-08fbf4b6><!--[--><span data-v-08fbf4b6>Overview</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-9fd4d1dd data-v-3f90c1a5><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-3f90c1a5 data-v-be9742d9 data-v-b4ccac88><span class="check" data-v-b4ccac88><span class="icon" data-v-b4ccac88><!--[--><span class="vpi-sun sun" data-v-be9742d9></span><span class="vpi-moon moon" data-v-be9742d9></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-9fd4d1dd data-v-ef6192dc data-v-e71e869c><!--[--><a class="VPSocialLink no-icon" href="https://github.com/yhzhang0128/egos-2000" aria-label="github" target="_blank" rel="noopener" data-v-e71e869c data-v-358b6670><span class="vpi-social-github" /></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-9fd4d1dd data-v-f953d92f data-v-af5898d3><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-af5898d3><span class="vpi-more-horizontal icon" data-v-af5898d3></span></button><div class="menu" data-v-af5898d3><div class="VPMenu" data-v-af5898d3 data-v-20ed86d6><!----><!--[--><!--[--><!----><div class="group" data-v-f953d92f><div class="item appearance" data-v-f953d92f><p class="label" data-v-f953d92f>Appearance</p><div class="appearance-action" data-v-f953d92f><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-f953d92f data-v-be9742d9 data-v-b4ccac88><span class="check" data-v-b4ccac88><span class="icon" data-v-b4ccac88><!--[--><span class="vpi-sun sun" data-v-be9742d9></span><span class="vpi-moon moon" data-v-be9742d9></span><!--]--></span></span></button></div></div></div><div class="group" data-v-f953d92f><div class="item social-links" data-v-f953d92f><div class="VPSocialLinks social-links-list" data-v-f953d92f data-v-e71e869c><!--[--><a class="VPSocialLink no-icon" href="https://github.com/yhzhang0128/egos-2000" aria-label="github" target="_blank" rel="noopener" data-v-e71e869c data-v-358b6670><span class="vpi-social-github" /></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-9fd4d1dd data-v-6bee1efd><span class="container" data-v-6bee1efd><span class="top" data-v-6bee1efd></span><span class="middle" data-v-6bee1efd></span><span class="bottom" data-v-6bee1efd></span></span></button></div></div></div></div><div class="divider" data-v-9fd4d1dd><div class="divider-line" data-v-9fd4d1dd></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-d8b57b2d data-v-2488c25a><div class="container" data-v-2488c25a><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-2488c25a><span class="vpi-align-left menu-icon" data-v-2488c25a></span><span class="menu-text" data-v-2488c25a>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-2488c25a data-v-883964e0><button data-v-883964e0>Return to top</button><!----></div></div></div><aside class="VPSidebar" data-v-d8b57b2d data-v-42c4c606><div class="curtain" data-v-42c4c606></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-42c4c606><span class="visually-hidden" id="sidebar-aria-label" data-v-42c4c606> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="no-transition group" data-v-51288d80><section class="VPSidebarItem level-0 has-active" data-v-51288d80 data-v-edd2eed8><!----><div class="items" data-v-edd2eed8><!--[--><div class="VPSidebarItem level-1 is-link" data-v-edd2eed8 data-v-edd2eed8><div class="item" data-v-edd2eed8><div class="indicator" data-v-edd2eed8></div><a class="VPLink link link" href="/book/overview.html" data-v-edd2eed8><!--[--><p class="text" data-v-edd2eed8>Overview</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-edd2eed8 data-v-edd2eed8><div class="item" data-v-edd2eed8><div class="indicator" data-v-edd2eed8></div><a class="VPLink link link" href="/book/p0_hello.html" data-v-edd2eed8><!--[--><p class="text" data-v-edd2eed8>P0: Hello, World!</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-edd2eed8 data-v-edd2eed8><div class="item" data-v-edd2eed8><div class="indicator" data-v-edd2eed8></div><a class="VPLink link link" href="/book/p1_ct.html" data-v-edd2eed8><!--[--><p class="text" data-v-edd2eed8>P1: Cooperative Threads</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-edd2eed8 data-v-edd2eed8><div class="item" data-v-edd2eed8><div class="indicator" data-v-edd2eed8></div><a class="VPLink link link" href="/book/p2_mlfq.html" data-v-edd2eed8><!--[--><p class="text" data-v-edd2eed8>P2: Preemptive Scheduler</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-edd2eed8 data-v-edd2eed8><div class="item" data-v-edd2eed8><div class="indicator" data-v-edd2eed8></div><a class="VPLink link link" href="/book/p3_syscall.html" data-v-edd2eed8><!--[--><p class="text" data-v-edd2eed8>P3: System Call & Protection</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-edd2eed8 data-v-edd2eed8><div class="item" data-v-edd2eed8><div class="indicator" data-v-edd2eed8></div><a class="VPLink link link" href="/book/p4_vm.html" data-v-edd2eed8><!--[--><p class="text" data-v-edd2eed8>P4: Virtual Memory</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-edd2eed8 data-v-edd2eed8><div class="item" data-v-edd2eed8><div class="indicator" data-v-edd2eed8></div><a class="VPLink link link" href="/book/p5_io.html" data-v-edd2eed8><!--[--><p class="text" data-v-edd2eed8>P5: I/O Device Driver</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-edd2eed8 data-v-edd2eed8><div class="item" data-v-edd2eed8><div class="indicator" data-v-edd2eed8></div><a class="VPLink link link" href="/book/p6_file.html" data-v-edd2eed8><!--[--><p class="text" data-v-edd2eed8>P6: File System</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-edd2eed8 data-v-edd2eed8><div class="item" data-v-edd2eed8><div class="indicator" data-v-edd2eed8></div><a class="VPLink link link" href="/book/p7_net.html" data-v-edd2eed8><!--[--><p class="text" data-v-edd2eed8>P7: Ethernet & TCP/IP</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-edd2eed8 data-v-edd2eed8><div class="item" data-v-edd2eed8><div class="indicator" data-v-edd2eed8></div><a class="VPLink link link" href="/book/p8_lock.html" data-v-edd2eed8><!--[--><p class="text" data-v-edd2eed8>P8: Multicore & Locks</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-edd2eed8 data-v-edd2eed8><div class="item" data-v-edd2eed8><div class="indicator" data-v-edd2eed8></div><a class="VPLink link link" href="/book/outcome.html" data-v-edd2eed8><!--[--><p class="text" data-v-edd2eed8>The Learning Outcomes</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-d8b57b2d data-v-9a6c75ad><div class="VPDoc has-sidebar has-aside" data-v-9a6c75ad data-v-e6f2a212><!--[--><!--]--><div class="container" data-v-e6f2a212><div class="aside" data-v-e6f2a212><div class="aside-curtain" data-v-e6f2a212></div><div class="aside-container" data-v-e6f2a212><div class="aside-content" data-v-e6f2a212><div class="VPDocAside" data-v-e6f2a212 data-v-cb998dce><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-cb998dce data-v-f610f197><div class="content" data-v-f610f197><div class="outline-marker" data-v-f610f197></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-f610f197>On this page</div><ul class="VPDocOutlineItem root" data-v-f610f197 data-v-53c99d69><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-cb998dce></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-e6f2a212><div class="content-container" data-v-e6f2a212><!--[--><!--]--><main class="main" data-v-e6f2a212><div style="position:relative;" class="vp-doc _book_p6_file" data-v-e6f2a212><div><h1 id="file-system" tabindex="-1">File System <a class="header-anchor" href="#file-system" aria-label="Permalink to &quot;File System&quot;">​</a></h1><p>In the previous project, you have seen how to read and write disk blocks, and you will now study how to build a <strong>file system</strong>. A file system uses the disk to provide the abstractions of <strong>files</strong> and <strong>directories</strong> (aka. folders), which you should have been familiar with through your everyday interactions with operating systems (e.g., <a href="https://en.wikipedia.org/wiki/Finder_(software)" target="_blank" rel="noreferrer">Finder</a> in MacOS). There are numerous file systems, and many of them are based on an abstraction called <strong>inode</strong>. We thus start by explaining this important file system abstraction.</p><h2 id="inode-and-inode-store" tabindex="-1">Inode and inode store <a class="header-anchor" href="#inode-and-inode-store" aria-label="Permalink to &quot;Inode and inode store&quot;">​</a></h2><p>Consider an inode as a number of blocks and a file system as an array of inodes. Say a file system maintains 1024 inodes, and each inode holds the information of a file or a directory. For example, inodes in a file system could be used as follows.</p><ol><li>Inode #12 holds 1 disk block for a small text file.</li><li>Inode #103 holds 31 disk blocks for the executable file of the <code>cat</code> command.</li><li>Inode #781 holds 1 disk block for the <code>/bin</code> directory recording the information of all files under directory <code>/bin</code>. This directory contains executable files of commands like <code>cat</code>.</li></ol><p>The <code>mkfs</code> tool gives a simple and concrete example of how inodes are used in egos-2000.</p><h3 id="use-of-inodes-in-mkfs" tabindex="-1">Use of inodes in <code>mkfs</code> <a class="header-anchor" href="#use-of-inodes-in-mkfs" aria-label="Permalink to &quot;Use of inodes in `mkfs`&quot;">​</a></h3><p>When you type <code>make install</code> or <code>make qemu</code> in egos-2000, the command will compile and run <code>tools/mfks.c</code> which produces a disk image file. Below is part of its output.</p><div class="language-shell vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> make install</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[INFO] Load ino</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">0,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> 34</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bytes</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[INFO] Load ino</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">1,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> 48</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bytes</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[INFO] Load ino</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">2,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> 26</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bytes</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[INFO] Load ino</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">3,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> 15</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bytes</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[INFO] Load ino</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">4,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> 15</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bytes</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[INFO] Load ino</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">5,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> 349</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bytes</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[INFO] Load ino</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">7,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> cat.elf:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 15600</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bytes</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[INFO] Load ino</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">8,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> tcp_demo.elf:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10680</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bytes</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[INFO] Load ino</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">9,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> loop.elf:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 11188</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bytes</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[INFO] Load ino</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">10,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.elf:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 15644</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bytes</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[INFO] Load ino</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">11,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> video_demo.elf:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 9388</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bytes</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[INFO] Load ino</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">12,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> crash1.elf:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 16772</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bytes</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[INFO] Load ino</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">13,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> crash2.elf:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 9432</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bytes</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[INFO] Load ino</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">14,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ls.elf:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10408</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bytes</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[INFO] Load ino</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">15,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> udp_demo.elf:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 9832</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bytes</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[INFO] Load ino</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">16,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.elf:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10144</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bytes</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[INFO] Load ino</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">6,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ./</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   6</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ../</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cat</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   7</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tcp_demo</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   8</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> loop</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   9</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cd</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  10</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> video_demo</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  11</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> crash1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  12</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> crash2</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  13</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ls</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  14</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> udp_demo</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  15</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> echo</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  16</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>Let&#39;s take a closer look at these 17 inodes numbered from #0 to #16.</p><h4 id="inodes-for-directories" tabindex="-1">Inodes for directories <a class="header-anchor" href="#inodes-for-directories" aria-label="Permalink to &quot;Inodes for directories&quot;">​</a></h4><p>Inode #0, #1, #2, #3, #4, and #6 are used for directories. The table below summarizes how the code in <code>tools/mfks.c</code> uses these inodes.</p><table tabindex="0"><thead><tr><th>Inode</th><th>Corresponding directory</th><th>Bytes stored in the inode</th></tr></thead><tbody><tr><td>#0</td><td><code>/</code></td><td><code>./ 0 ../ 0 home/ 1 bin/ 6 </code></td></tr><tr><td>#1</td><td><code>/home</code></td><td><code>./ 1 ../ 0 yunhao/ 2 rvr/ 3 yacqub/ 4 </code></td></tr><tr><td>#2</td><td><code>/home/yunhao</code></td><td><code>./ 2 ../ 1 README 5 </code></td></tr><tr><td>#3</td><td><code>/home/rvr</code></td><td><code>./ 3 ../ 1 </code></td></tr><tr><td>#4</td><td><code>/home/yacqub</code></td><td><code>./ 4 ../ 1 </code></td></tr><tr><td>#6</td><td><code>/bin</code></td><td><code>./ 6 ../ 0 cat 7 tcp_demo 8 loop 9 cd 10 video_demo 11 crash1 12 crash2 13 ls 14 udp_demo 15 echo 16</code></td></tr></tbody></table><p>First, every directory contains <code>./</code> and <code>../</code> corresponding to itself and its parent directory. For example, the parent directory of both <code>/bin</code> and <code>/home</code> is <code>/</code>, illustrated by the <code>../ 0</code> part of inode #1 and #6. In general, egos-2000 uses the format <code>{name} {inode no} ...</code> to represent a directory. If a <code>{name}</code> ends with <code>/</code>, this name would represent a sub-directory (e.g., <code>rvr/</code> in inode #1). Otherwise, this name represents a file (e.g., <code>cat</code> in inode #6). We use this naming convention for directories because it is simple. In most file systems, inodes will record more information such as the size or creation time of a file or directory.</p><p>All the inodes in this table hold fewer than 512 bytes, so they all hold only one disk block.</p><h4 id="inodes-for-files" tabindex="-1">Inodes for files <a class="header-anchor" href="#inodes-for-files" aria-label="Permalink to &quot;Inodes for files&quot;">​</a></h4><p>Inode #5 and #7..#16 are used for files. For example, as shown in the table, inode #5 is for <code>/home/yunhao/README</code> which is a short text file. The content of this text file is defined by the 349 bytes of <code>contents[5]</code> in <code>tools/mkfs.c</code>. Since 349 is smaller than the block size of 512 bytes, inode #5 also holds only one disk block for this README file.</p><p>As shown in the <code>mkfs</code> printing above, inode #7..#16 are used for the binary executable files of user commands, and they hold more than one disk block because each of the executable files is larger than 512 bytes. For example, command <code>echo</code> corresponds to inode #16 which holds 10144 bytes (i.e., <code>ceil(10144/512)=20</code> disk blocks).</p><p>Lastly, <code>NINODES</code> is defined as 128 in header file <code>library/file/inode.h</code>, and <code>mkfs</code> uses <code>NINODES</code> to initialize the file system. This means that the file system supports 128 inodes in total, but only 17 of them are used when egos-2000 starts to boot.</p><div class="tip custom-block github-alert"><p class="custom-block-title">TIP</p><p>Our goal is to give you a concrete and minimal example of how a file system could be organised as an array of inodes. Make sure that you see how different inodes can hold different numbers of disk blocks, and how an inode can be used as either a file or a directory. In the rest of P6, we will focus on the inode abstraction, and ignore how a file system maps a file or directory to an inode number.</p></div><h3 id="the-inode-store-interface" tabindex="-1">The inode store interface <a class="header-anchor" href="#the-inode-store-interface" aria-label="Permalink to &quot;The inode store interface&quot;">​</a></h3><p>In addition to <code>NINODES</code>, the header file <code>library/file/inode.h</code> defines <code>inode_intf</code>.</p><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">typedef</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> inode_store</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> inode_intf;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> /* inode store interface */</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> inode_store {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">getsize)(inode_intf self, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">uint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ino);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">setsize)(inode_intf self, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">uint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ino, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">uint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> newsize);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">read)(inode_intf self, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">uint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ino, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">uint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> offset, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">block_t</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> block);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">write)(inode_intf self, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">uint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ino, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">uint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> offset, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">block_t</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> block);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    void*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> state;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>In short, <code>inode_store</code> defines the file system interface in egos-2000, and there are two file systems (i.e., <code>file0.c</code> and <code>file1.c</code> under <code>library/file</code>) implementing this interface. In particular, each file system implements 4 functions <code>read</code>, <code>write</code>, <code>getsize</code> and <code>setsize</code>, and maintains some in-memory <code>state</code>. A pointer needs 4 bytes, so <code>struct inode_store</code> simply holds 20 bytes, and the first 16 bytes hold the addresses of the 4 interface functions (i.e., the address of their first instruction).</p><p>If you are familiar with object-oriented programming, you may consider <code>inode_store</code> as an interface (aka. template), and a file system as a class with a local variable and four methods implementing this interface. This explains the <code>self</code> argument of the interface functions, so a file system can access its in-memory state using <code>self-&gt;state</code>. In C, <code>self</code> holds 4 bytes as the address of the 20-byte <code>struct inode_store</code>.</p><p>For <code>read</code> and <code>write</code>, there are 3 more arguments: <code>ino</code> is the inode number, <code>offset</code> is the block number, and <code>block</code> is the memory address of 512 bytes holding the block data. For example, as we have seen, the executable of <code>echo</code> maps to inode #16 which holds 20 blocks. We can thus read inode #16 with an offset in range 0..19.</p><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// block_t defined in library/file/disk.h</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BLOCK_SIZE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 512</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">typedef</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> block {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    char</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> bytes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[BLOCK_SIZE];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">block_t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// This block variable holds 512 bytes in the memory.</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">block_t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> block;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Given `inode_intf fs`, read block #4 from block #0..#19 of inode #16.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">fs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">read</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(fs, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">16</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">block</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="a-simple-file-system" tabindex="-1">A simple file system <a class="header-anchor" href="#a-simple-file-system" aria-label="Permalink to &quot;A simple file system&quot;">​</a></h3><p>We now explain a simple file system in <code>library/file/file0.c</code> which implements the inode store interface <code>inode_intf</code>. We start with the <code>mydisk_init</code> function.</p><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">inode_intf </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mydisk_init</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(inode_intf </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">below</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">uint</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> below_ino</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    inode_intf self </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> malloc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> inode_store));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    self-&gt;getsize   </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mydisk_getsize;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    self-&gt;setsize   </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mydisk_setsize;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    self-&gt;read      </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mydisk_read;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    self-&gt;write     </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mydisk_write;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    self-&gt;state     </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> below;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> self;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>The code allocates 20 bytes for the inode store interface, and sets the 4 interface functions as the <code>mydisk_*</code> functions defined in <code>file0.c</code>. Then <code>below</code> is recorded as <code>self-&gt;state</code> since the file system needs <code>below</code> for reading and writing the disk. For example, in <code>apps/system/sys_file.c</code>, there is another inode store called <code>disk</code> which simply reads or writes the disk with an offset, ignoring the inode number. A pointer to this <code>disk</code> variable is passed to <code>mydisk_init</code> as the <code>below</code> argument (i.e., <code>mydisk_init(&amp;disk, 0)</code> in <code>sys_file.c</code>).</p><p>After assigning <code>&amp;disk</code> to <code>self-&gt;state</code> in the <code>mydisk_init</code> function, the file system read and write functions can use <code>self-&gt;state</code> to read the disk as follows.</p><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> DUMMY_DISK_OFFSET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ino</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">offset</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) ino </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 128</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> offset</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> mydisk_read</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(inode_intf </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">uint</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> ino</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">uint</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> offset</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">block_t</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> block</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    inode_intf below </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> self-&gt;state;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> below-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">read</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(below, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">DUMMY_DISK_OFFSET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ino, offset), block);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> mydisk_write</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(inode_intf </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">uint</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> ino</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">uint</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> offset</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">block_t</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> block</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    inode_intf below </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> self-&gt;state;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> below-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">write</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(below, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">DUMMY_DISK_OFFSET</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ino, offset), block);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>This simple file system assumes that every inode holds at most 128 blocks, and operations to <code>(ino, offset)</code> are directly translated to reading or writing disk block <code>ino*128+offset</code>. This is probably the simplest way of implementing the inode store interface and supporting a file system that is barely enough to boot egos-2000.</p><div class="tip custom-block github-alert"><p class="custom-block-title">TIP</p><p>The <code>mydisk_getsize</code> and <code>mydisk_setsize</code> functions simply print out an error and halt, meaning that they are not used when booting egos-2000. You will start from here and implement your own file system in the <code>mydisk_*</code> functions in <code>file0.c</code>. Make sure to set <code>FILESYS = 0</code> in <code>Makefile</code>, so <code>mkfs</code> and egos-2000 run your file system code. Specifically, after <code>make install</code>, you should see <code>MKFS is using *mydisk*</code> instead of <code>MKFS is using *treedisk*</code>.</p></div><h2 id="a-sophisticated-file-system" tabindex="-1">A sophisticated file system <a class="header-anchor" href="#a-sophisticated-file-system" aria-label="Permalink to &quot;A sophisticated file system&quot;">​</a></h2><p>Your job in this project is to implement some more sophisticated data structure for the inode store interface functions. When you modify such data structures, you typically need to read a disk block into memory, apply your modifications in the memory, and write the block back to the disk. The data structures involved here are not complicated, but students often forget to apply their modifications in the memory back to the disk, leading to subtle bugs.</p><p>Regarding the data structure, you will implement a few <em>linked lists</em> similar to how the <a href="https://en.wikipedia.org/wiki/File_Allocation_Table" target="_blank" rel="noreferrer">FAT file system</a> is organised. We now explain how you could maintain one linked list for each inode, and one linked list for all the unused blocks on the disk.</p><h3 id="linked-list" tabindex="-1">Linked list <a class="header-anchor" href="#linked-list" aria-label="Permalink to &quot;Linked list&quot;">​</a></h3><p>Suppose inode #28 has 3 blocks: block #100, #202 and #432 on the disk. We can then use a simple linked list data structure to represent this inode as follows.</p><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> inode {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> size, head;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">inodes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">128</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">inodes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">28</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].size </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">inodes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">28</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].head </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> entry {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> next;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">FAT_entry</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[DISK_SIZE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> BLOCK_SIZE];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">FAT_entry</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]  </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 202</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">FAT_entry</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">202</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]  </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 432</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">FAT_entry</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">432</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]  </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>We call it <code>FAT_entry</code> because it is similar to how the FAT file system maintains a linked list. However, if you define <code>inodes</code> and <code>FAT_entry</code> in C like above, they will be in the memory. Instead, we should write these two arrays to the disk so that the file system information still exists on the disk after we power off the computer.</p><h3 id="create-the-disk-layout" tabindex="-1">Create the disk layout <a class="header-anchor" href="#create-the-disk-layout" aria-label="Permalink to &quot;Create the disk layout&quot;">​</a></h3><p>This picture shows how you could put the linked list data structures on the disk.</p><p><img src="/assets/layout.CVJzAT0U.png" alt="Failed to load picture"></p><p>We split the disk into 4 regions. The first block is called the super block. The next <code>I</code> blocks are called inode blocks, holding the <code>inodes</code> array. The next <code>F</code> blocks are called FAT table blocks, holding the <code>FAT_entry</code> array. All the other blocks starting from <code>I+F+1</code> are used as data blocks. Since the size of <code>struct inode</code> and <code>struct entry</code> are 8 and 4 bytes, a block can hold 64 <code>struct inode</code> and 128 <code>struct entry</code>.</p><p>Therefore, for <code>FAT_entry[100] = 202</code>, we can read block <code>I+1</code> into memory as an array of 128 entries, modify entry #100, and write it back to the disk. Similarly, for <code>FAT_entry[202]</code>, we can read block <code>I+2</code> into memory, modify entry #74 (i.e., <code>202%128==74</code>), and then write it back to the disk. Modifying the <code>inodes</code> array with disk blocks <code>1..I</code> is similar.</p><p>Your first task is to implement the <code>mydisk_create</code> function according to the picture above. This function initializes the file system on the disk, a process also known as <a href="https://en.wikipedia.org/wiki/Disk_formatting" target="_blank" rel="noreferrer">disk formatting</a>. Specifically, you will do the following.</p><ul><li>Calculate <code>I</code> and <code>F</code> based on the number of inodes and the disk size.</li><li>Set the <code>size</code> of all the inodes to 0, and set the <code>head</code> of all the inodes to -1.</li><li>Create a linked list containing blocks <code>I+F+1..N</code>, which is called the initial free list.</li><li>Define a data structure for the super block which records <code>I</code>, <code>F</code>, as well as the head of the initial free list, and write this data structure to the super block.</li><li>You don&#39;t have to initialize the data blocks.</li></ul><p>After the steps above, we will have a file system with all the inodes being empty, and all the data blocks in the free list. You could also read the <code>treedisk_create</code> function in <code>library/file/file1.c</code> as a reference.</p><div class="tip custom-block github-alert"><p class="custom-block-title">TIP</p><p>Many file systems maintain a tree data structure instead of linked lists. The most widely-used one is probably <a href="https://en.wikipedia.org/wiki/B-tree" target="_blank" rel="noreferrer">B-tree</a> which has a query complexity much lower than linked lists. Indeed, our solution code for this project runs slower than <code>treedisk</code> on QEMU, reflecting the difference in complexity.</p></div><h3 id="read-and-write-an-inode" tabindex="-1">Read and write an inode <a class="header-anchor" href="#read-and-write-an-inode" aria-label="Permalink to &quot;Read and write an inode&quot;">​</a></h3><p>Your next task is to implement the <code>mydisk_read</code> and <code>mydisk_write</code> functions. At a high level, <code>mydisk_read</code> involves the following steps.</p><ul><li>Read an inode block, and find the <code>struct inode</code> corresponding to the <code>ino</code> argument.</li><li>Check that the <code>offset</code> argument is smaller than the <code>size</code> field in the <code>struct inode</code>.</li><li>Traverse from the start of the linked list (i.e., the <code>head</code> field) by <code>offset</code> times, and thus find the disk block number for the data block.</li><li>Read the data block into the <code>block</code> argument of <code>mydisk_read</code>.</li></ul><p>The steps for <code>mydisk_write</code> are similar with one key difference. If the <code>offset</code> argument is larger than (or equal) the <code>size</code> field in the <code>struct inode</code>, remove <code>offset-size+1</code> blocks from the free list, and add these blocks to the inode. In other words, when writing to a large <code>offset</code>, you should expand the size of the inode by taking blocks from the free list. This is likely the trickiest part in this project, and make sure that you have updated all the 4 regions in the disk layout correctly.</p><p>After implementing the two functions, egos-2000 should be able to boot and run normally.</p><h3 id="get-and-set-inode-s-size" tabindex="-1">Get and set inode&#39;s size <a class="header-anchor" href="#get-and-set-inode-s-size" aria-label="Permalink to &quot;Get and set inode&#39;s size&quot;">​</a></h3><p>You can now implement <code>mydisk_getsize</code> and <code>mydisk_setsize</code>. <code>getsize</code> should be easy since it is basically the first step of <code>mydisk_read</code>. For <code>setsize</code>, start by implementing the case of <code>nblocks</code> being 0. For a non-zero <code>nblocks</code>, you can try to design helper functions shared by <code>setsize</code> and <code>write</code> which change the size of an inode.</p><p>Since egos-2000 does not use these functions, we provide a separate testing framework.</p><h2 id="test-your-file-system-code" tabindex="-1">Test your file system code <a class="header-anchor" href="#test-your-file-system-code" aria-label="Permalink to &quot;Test your file system code&quot;">​</a></h2><p>We provide a testing framework for your file system code in <a href="https://github.com/yhzhang0128/tiny-test" target="_blank" rel="noreferrer">this repo</a>. Specifically, you can replace the <code>file0.c</code> in the repo with your code, and follow the instructions in the README. To write a test case, you write a trace file similar to the <code>trace.txt</code> in this repo.</p><div class="language-txt vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">txt</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>W:0:0:123456789</span></span>
<span class="line highlighted"><span>W:1:0:1234567</span></span>
<span class="line"><span>W:1:1:333333</span></span>
<span class="line"><span>R:0:0:123456789</span></span>
<span class="line highlighted"><span>R:1:0:1234567</span></span>
<span class="line"><span>R:1:1:333333</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><code>W:1:0:1234567</code> means to issue a write operation to your file system with inode #1, offset 0, and block data filled by the number 1234567. <code>R:1:0:1234567</code> means to read from your file system with inode #1 and offset 0, and then check whether the block data returned by your file system still holds the number 1234567.</p><p>You should write a lot more test traces that are more complex than <code>trace.txt</code>, testing your file system code comprehensively. Remember to examine all the corner cases.</p><h2 id="accomplishments" tabindex="-1">Accomplishments <a class="header-anchor" href="#accomplishments" aria-label="Permalink to &quot;Accomplishments&quot;">​</a></h2><p>You have gained hands-on experience with the abstraction of <strong>inode</strong>, <strong>file</strong>, and <strong>directory</strong>. In terms of code reading, you have finished <code>library/file</code> and <code>tools/mkfs.c</code>. We touched a bit of <code>apps/system/sys_file.c</code> when explaining <code>mydisk_init</code>, and you can finish reading this short file which serves all file system requests in egos-2000 as a system process.</p></div></div></main><footer class="VPDocFooter" data-v-e6f2a212 data-v-1bcd8184><!--[--><!--]--><!----><nav class="prev-next" aria-labelledby="doc-footer-aria-label" data-v-1bcd8184><span class="visually-hidden" id="doc-footer-aria-label" data-v-1bcd8184>Pager</span><div class="pager" data-v-1bcd8184><a class="VPLink link pager-link prev" href="/book/p5_io.html" data-v-1bcd8184><!--[--><span class="desc" data-v-1bcd8184>Previous page</span><span class="title" data-v-1bcd8184>P5: I/O Device Driver</span><!--]--></a></div><div class="pager" data-v-1bcd8184><a class="VPLink link pager-link next" href="/book/p7_net.html" data-v-1bcd8184><!--[--><span class="desc" data-v-1bcd8184>Next page</span><span class="title" data-v-1bcd8184>P7: Ethernet & TCP/IP</span><!--]--></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><footer class="VPFooter has-sidebar" data-v-d8b57b2d data-v-566314d4><div class="container" data-v-566314d4><p class="message" data-v-566314d4>"... any person ... any study."</p><p class="copyright" data-v-566314d4>Ezra Cornell (1807-1874)</p></div></footer><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"book_outcome.md\":\"_8r2kCAx\",\"book_overview.md\":\"D7yRGCz-\",\"book_p0_hello.md\":\"BDM6QSoh\",\"book_p1_ct.md\":\"CbcEPFJO\",\"book_p2_mlfq.md\":\"CESUtVLQ\",\"book_p3_syscall.md\":\"_Z5BMgGY\",\"book_p4_vm.md\":\"BjPznP2K\",\"book_p5_io.md\":\"DRjF7mqi\",\"book_p6_file.md\":\"B4ou-fA7\",\"book_p7_net.md\":\"DxcH4tVM\",\"book_p8_lock.md\":\"BCxPn2W8\",\"index.md\":\"SRIk_n0M\",\"readme.md\":\"BKydlJrD\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"The EGOS book\",\"description\":\"Envision a future where every student can read all the code of a teaching operating system. \",\"base\":\"/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"nav\":[{\"text\":\"Vision\",\"link\":\"/\"},{\"text\":\"Overview\",\"link\":\"/book/overview\"}],\"sidebar\":[{\"items\":[{\"text\":\"Overview\",\"link\":\"/book/overview\"},{\"text\":\"P0: Hello, World!\",\"link\":\"/book/p0_hello\"},{\"text\":\"P1: Cooperative Threads\",\"link\":\"/book/p1_ct\"},{\"text\":\"P2: Preemptive Scheduler\",\"link\":\"/book/p2_mlfq\"},{\"text\":\"P3: System Call & Protection\",\"link\":\"/book/p3_syscall\"},{\"text\":\"P4: Virtual Memory\",\"link\":\"/book/p4_vm\"},{\"text\":\"P5: I/O Device Driver\",\"link\":\"/book/p5_io\"},{\"text\":\"P6: File System\",\"link\":\"/book/p6_file\"},{\"text\":\"P7: Ethernet & TCP/IP\",\"link\":\"/book/p7_net\"},{\"text\":\"P8: Multicore & Locks\",\"link\":\"/book/p8_lock\"},{\"text\":\"The Learning Outcomes\",\"link\":\"/book/outcome\"}]}],\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/yhzhang0128/egos-2000\"}],\"footer\":{\"copyright\":\"Ezra Cornell (1807-1874)\",\"message\":\"\\\"... any person ... any study.\\\"\"}},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":false}");</script>
    
  </body>
</html>